const { GraphQLServer, PubSub } = require('graphql-yoga')
const withFilter = require('graphql-subscriptions').withFilter

const options = {
    port: 8000,
    endpoint: 'https://api-us-east-1.graphcms.com/v2/ckptywdoqu6o001z65qcj2azf/master',
}

const typeDefs = `
    type Query {
        hello(name: String): String!
    }
    type Coordinates {
        latitude: String,
        longitude: String
    }
    type Result {
        coordinates: Coordinates
    }
    type Subscription {
        positions: Result!
    }
`;

function* generateName(){
    let i = 0

    while(true){
        yield i++
    }
}

const resolvers = {
  Query: {
    hello: (_, { name }) => `Hello ${name || 'World'}`,
  },
  Subscription: {
    positions: {
        subscribe: (_, __, {pubsub}) => {
            pubsub.publish(generateName.next(),{coordinates: {latitude: "3", longitude: "2"}})
            return pubsub.asyncIterator(generateName.next(),{coordinates: {latitude: "3", longitude: "2"}})
        }
    }
  },
};


const pubsub = new PubSub()

const server = new GraphQLServer({ typeDefs, resolvers, context: { pubsub }})

server.start(() => console.log('Server is running on localhost:4000'))